let accordionItemBtn = document.querySelectorAll(".accordion__item-btn");
accordionItemBtn.forEach((e => { e.addEventListener("click", (() => { e.parentElement.classList.toggle("active"); })); }));
let modalBoxAnswer = document.querySelectorAll(".modal__box-answer");
modalBoxAnswer.forEach((e => { e.addEventListener("click", (() => { e.classList.toggle("active"); })); }));
let modalBoxClose = document.querySelectorAll(".modal__box-close");
//modalBoxClose.forEach((e => { e.addEventListener("click", (() => { modalBox.forEach((e => { e.classList.remove("active"); })), document.querySelector(".modal__box").classList.add("active"), modalBoxAnswer.forEach((e => { e.classList.remove("active"); })); })); }));
let modalBoxBtn = document.querySelectorAll(".modal__box-btn"),
    modalBox = document.querySelectorAll(".modal__box");
let activeModal = document.querySelector(".modal__box.active");

let formClose = document.querySelectorAll("#formClose");
formClose.forEach((e => { e.addEventListener("click", (() => {
    document.querySelector('#form').style.display = 'none';
    modalBoxAnswer.forEach((e) => {
      e.classList.remove('active');
    });
   }));
}));

let modalBtns = document.querySelectorAll('a[href="#modal"]');
modalBtns.forEach((element) => {
  element.addEventListener('click', () => {
    document.querySelector('#modal').style.display = 'block';
  });
});

modalBoxClose.forEach((element) => {
  element.addEventListener('click', () => {
    document.querySelector('#modal').style.display = 'none';
  });
});

let formBtns = document.querySelectorAll('a[href="#form"]');
formBtns.forEach((element) => {
  element.addEventListener('click', () => {
    document.querySelector('#form').style.display = 'block';
    document.querySelector('#form .modal__box').classList.add('active');
  });
});

modalBoxBtn.forEach((btn, i) => {
  btn.addEventListener("click", () => {
    
    // получаем выбранный вариант ответа на текущем шаге
    const currentAnswerText = document.querySelector('.modal__box.active .modal__box-answer.active')?.textContent.trim();

    // если в предпоследнем ответе выбрано "Вы своими силами"
    if (currentAnswerText === 'Вы своими силами' || currentAnswerText === 'Вы сами') {
      // проверяем, есть ли следующий шаг
      if (i + 2 < modalBox.length - 1) {
        // убираем класс active у текущего блока
        activeModal.classList.remove("active");
          
        // добавляем класс active следующему блоку
        modalBox[i+2].classList.add("active");
        // устанавливаем новый active для последующих кликов
        activeModal = modalBox[i+2];
      } else {
        // ситуация, когда выбран последний ответ "Вы своими силами",
        // и в следующем шаге уже нет блока для добавления - можно отправлять форму
        document.querySelector('.modal__box-form').submit();
      }
    } else {
      // выбран другой ответ
      // убираем класс active у текущего блока
      activeModal.classList.remove("active");
      
      // добавляем класс active следующему блоку
      modalBox[i+1].classList.add("active");
      
      // устанавливаем новый active для последующих кликов
      activeModal = modalBox[i+1];
    }
  });
});

//запись ответов
// получаем все кнопки
const btns = document.querySelectorAll('.modal__box-answer');
const questionText = "";

// хранит ссылки на span-элементы для каждого вопроса
const answerEls = {};

const totalTableName = document.querySelector("#totalTableName");
const totalTableCol = document.querySelector("#totalTableCol");
const totalPriceBlock = document.getElementById('totalPrice');
let selectedAnswer = {}; // объект для хранения выбранных ответов

// создаем span-элементы для каждого вопроса и сохраняем их в answerEls
btns.forEach(btn => {
  const question = btn.getAttribute("data-question");
  const questionClass = "question-" + transliterate(question);

  if (!selectedAnswer[questionClass]) {
    selectedAnswer[questionClass] = {
      question: question,
      answer: ""
    };
  }

  btn.addEventListener('click', () => {
    const answerText = btn.textContent.trim();

    const answersInBlock = btn.parentElement.querySelectorAll('.modal__box-answer');
    answersInBlock.forEach(answer => {
      if (answer !== btn && answer.classList.contains('active')) {
        answer.classList.remove('active');
      }
    });

    const existingQuestion = totalTableName.querySelector(`.question-${transliterate(question)}`);
    const existingAnswer = totalTableCol.querySelector(`.question-${transliterate(question)}`);

    if (existingQuestion && existingAnswer) {
      existingQuestion.textContent = questionText + question;
      existingAnswer.textContent = answerText;
    } else {
      const newQuestion = document.createElement('div');
      newQuestion.classList.add("question__text");
      newQuestion.classList.add("price__table-item_name");
      newQuestion.classList.add(`question-${transliterate(question)}`);
      newQuestion.textContent = questionText + question;

      const newAnswer = document.createElement('div');
      newAnswer.classList.add("question__text");
      newAnswer.classList.add("price__table-item_name");
      newAnswer.classList.add(`question-${transliterate(question)}`);
      newAnswer.textContent = answerText;

      totalTableName.appendChild(newQuestion);
      totalTableCol.appendChild(newAnswer);
    }

    selectedAnswer[questionClass].answer = answerText;

    // Обновление итоговой суммы в блоке totalPrice
    let totalPrice = calculateTotalPrice();

    totalPriceBlock.textContent = totalPrice;
    
    btn.classList.add('active');
  });
});

function calculateTotalPrice() {
  let totalPrice = 0;

  // Логика для определения итоговой суммы на основе выбранных ответов
  if (selectedAnswer["question-Oтkuda-zaбиraeм"] && selectedAnswer["question-Oтkuda-zaбиraeм"].answer === "Южные Ворота") {
    totalPrice += 1500;
  } else if (selectedAnswer["question-Oтkuda-zaбиraeм"] && selectedAnswer["question-Oтkuda-zaбиraeм"].answer === "ТЯК Москва") {
    totalPrice += 2500;
  }

  if (selectedAnswer["question-Количество товара к упаковке"] && selectedAnswer["question-Количество товара к упаковке"].answer === "3000 и более") {
    totalPrice += 7;
  } else {
    totalPrice += 8;
  }

  if (selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"] && selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"].answer === "БОПП пакет" || selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"].answer === "ЗипЛок") {
    totalPrice += 6;
  } else if (selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"] && selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"].answer === "Пузырчатая плёнка"
    || selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"].answer === "Крафтовая бумага"){
      totalPrice += 8;
  } else if (selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"] && selectedAnswer["question-Vyбerитe-мaтerиaly-dlя-upakovkи"].answer === "Отдельный короб"){
      totalPrice += 25;
  }

  if(selectedAnswer["question-Kollичeстvo-eтиkeтok-prи-мarkиrovke"] && selectedAnswer["question-Kollичeстvo-eтиkeтok-prи-мarkиrovke"].answer === "1 этикетка"){
    totalPrice += 3;
  } else if (selectedAnswer["question-Kollичeстvo-eтиkeтok-prи-мarkиrovke"] && selectedAnswer["question-Kollичeстvo-eтиkeтok-prи-мarkиrovke"].answer === "2 этикетки"){
    totalPrice += 6;
  } else if (selectedAnswer["question-Kollичeстvo-eтиkeтok-prи-мarkиrovke"] && selectedAnswer["question-Kollичeстvo-eтиkeтok-prи-мarkиrovke"].answer === "3 этикетки"){
    totalPrice += 9;
  }

  if(selectedAnswer["question-Kak-doстavlяeм-тovar"] && selectedAnswer["question-Kak-doстavlяeм-тovar"].answer === "В коробе 60х40х40"){
    totalPrice += 140;
  } else if (selectedAnswer["question-Kak-doстavlяeм-тovar"] && selectedAnswer["question-Kak-doстavlяeм-тovar"].answer === "Паллета + короб 60х40х40 12шт"){
    totalPrice += 2740;
  }

  if(selectedAnswer["question-CHтo-gruzим"] && selectedAnswer["question-CHтo-gruzим"].answer === "Паллета"){
    totalPrice += 500; 
  } else if (selectedAnswer["question-CHтo-gruzим"] && selectedAnswer["question-CHтo-gruzим"].answer === "Короб") {
    totalPrice += 200;
  }

  if(selectedAnswer["question-Kuda-doстavlяeм"] && selectedAnswer["question-Kuda-doстavlяeм"].answer === "Электросталь"){
      totalPrice += 2000;
  } else if(selectedAnswer["question-Kuda-doстavlяeм"] && selectedAnswer["question-Kuda-doстavlяeм"].answer === "Коледино"){
      totalPrice += 400;
  } else if(selectedAnswer["question-Kuda-doстavlяeм"] && selectedAnswer["question-Kuda-doстavlяeм"].answer === "СЦ Пушкино"){
      totalPrice += 200;
  }

  return totalPrice;
}




function transliterate(text) {
  const translitMap = {
    "Ё": "YO",
    "Й": "I",
    "Ц": "TS",
    "У": "U",
    "К": "K",
    "Е": "E",
    "Н": "N",
    "Г": "G",
    "Ш": "SH",
    "Щ": "SCH",
    "З": "Z",
    "Х": "H",
    "Ъ": "",
    "ё": "yo",
    "й": "i",
    "ц": "ts",
    "у": "u",
    "к": "k",
    "е": "e",
    "н": "n",
    "г": "g",
    "ш": "sh",
    "щ": "sch",
    "з": "z",
    "х": "h",
    "ъ": "",
    "Ф": "F",
    "Ы": "Y",
    "В": "V",
    "А": "A",
    "П": "P",
    "Р": "R",
    "О": "O",
    "Л": "L",
    "Д": "D",
    "Ж": "ZH",
    "Э": "E",
    "ф": "f",
    "ы": "y",
    "в": "v",
    "а": "a",
    "п": "p",
    "р": "r",
    "о": "o",
    "л": "l",
    "д": "d",
    "ж": "zh",
    "э": "e",
    "Я": "YA",
    "Ч": "CH",
    "С": "S",
    "М": "M",
    "И": "I",
    "Т": "T",
    "Ь": "",
    "Б": "B",
    "Ю": "YU",
    "я": "ya",
    "ч": "ch",
    "с": "s",
    "м": "m",
    "и": "i",
    "т": "t",
    "ь": "",
    "б": "b",
    "ю": "yu"
  };
  
  return text.replace(/[ЁЙЦУКЕНГШЩЗХЪёйцукенгшщзхъФЫВАПРОЛДЭфывапролджэЯЧСМИТЬБЮ]/g, function(match) {
    return translitMap[match];
  }).replace(/[\s]/g, "-");
}



let backBtn = document.querySelectorAll(".modal__box-back");

backBtn.forEach((btn, i) => {
  btn.addEventListener("click", () => {
    activeModal.classList.remove("active");
    modalBox[i].classList.add("active");
    activeModal = modalBox[i]; 
  });
});