let accordionItemBtn = document.querySelectorAll(".accordion__item-btn");
accordionItemBtn.forEach((e => { e.addEventListener("click", (() => { e.parentElement.classList.toggle("active"); })); }));
let modalBoxAnswer = document.querySelectorAll(".modal__box-answer");
modalBoxAnswer.forEach((e => { e.addEventListener("click", (() => { e.classList.toggle("active"); })); }));
let modalBoxClose = document.querySelectorAll(".modal__box-close");
//modalBoxClose.forEach((e => { e.addEventListener("click", (() => { modalBox.forEach((e => { e.classList.remove("active"); })), document.querySelector(".modal__box").classList.add("active"), modalBoxAnswer.forEach((e => { e.classList.remove("active"); })); })); }));
let modalBoxBtn = document.querySelectorAll(".modal__box-btn"),
    modalBox = document.querySelectorAll(".modal__box");
let activeModal = document.querySelector(".modal__box.active");

let formClose = document.querySelectorAll("#formClose");
formClose.forEach((e => { e.addEventListener("click", (() => {
    document.querySelector('#form').style.display = 'none';
    modalBoxAnswer.forEach((e) => {
      e.classList.remove('active');
    });
   }));
}));

let modalBtns = document.querySelectorAll('a[href="#modal"]');
modalBtns.forEach((element) => {
  element.addEventListener('click', () => {
    document.querySelector('#modal').style.display = 'block';
  });
});

modalBoxClose.forEach((element) => {
  element.addEventListener('click', () => {
    document.querySelector('#modal').style.display = 'none';
  });
});

let formBtns = document.querySelectorAll('a[href="#form"]');
formBtns.forEach((element) => {
  element.addEventListener('click', () => {
    document.querySelector('#form').style.display = 'block';
    document.querySelector('#form .modal__box').classList.add('active');
  });
});

modalBoxBtn.forEach((btn, i) => {
  btn.addEventListener("click", () => {
    
    // получаем выбранный вариант ответа на текущем шаге
    const currentAnswerText = document.querySelector('.modal__box.active .modal__box-answer.active')?.textContent.trim();

    // если в предпоследнем ответе выбрано "Вы своими силами"
    if (currentAnswerText === 'Вы своими силами' || currentAnswerText === 'Вы сами') {
      // проверяем, есть ли следующий шаг
      if (i + 2 < modalBox.length - 1) {
        // убираем класс active у текущего блока
        activeModal.classList.remove("active");
          
        // добавляем класс active следующему блоку
        modalBox[i+2].classList.add("active");
        // устанавливаем новый active для последующих кликов
        activeModal = modalBox[i+2];
      } else {
        // ситуация, когда выбран последний ответ "Вы своими силами",
        // и в следующем шаге уже нет блока для добавления - можно отправлять форму
        document.querySelector('.modal__box-form').submit();
      }
    } else {
      // выбран другой ответ
      // убираем класс active у текущего блока
      activeModal.classList.remove("active");
      
      // добавляем класс active следующему блоку
      modalBox[i+1].classList.add("active");
      
      // устанавливаем новый active для последующих кликов
      activeModal = modalBox[i+1];
    }
  });
});

//запись ответов
// получаем все кнопки
const btns = document.querySelectorAll('.modal__box-answer');
const questionText = "";

// хранит ссылки на span-элементы для каждого вопроса
const answerEls = {};

const totalTableName = document.querySelector("#totalTableName");
const totalTableCol = document.querySelector("#totalTableCol");

// создаем span-элементы для каждого вопроса и сохраняем их в answerEls
btns.forEach(btn => {
  const question = btn.getAttribute("data-question");
  const questionClass = "question-" + transliterate(question);

  // создаем span-элемент для вопроса (если еще не создали)
  if (!answerEls[questionClass]) {
    const questionEl = document.createElement("div");
    questionEl.classList.add(questionClass);
    questionEl.classList.add("question__text");
    questionEl.textContent = questionText + question;
    answerEls[questionClass] = { question: questionEl };
  }

  // создаем span-элемент для ответа (если еще не создали)
  if (!answerEls[questionClass].answer) {
    const answerEl = document.createElement("div");
    answerEl.classList.add(questionClass);
    answerEl.classList.add("question__text");
    answerEls[questionClass].answer = answerEl;
  }

  // добавляем обработчик события на кнопку
  btn.addEventListener('click', () => {
    const answerText = btn.textContent.trim();

    // удаляем активный класс у других вариантов ответа в этом блоке
    const answersInBlock = btn.parentElement.querySelectorAll('.modal__box-answer');
    answersInBlock.forEach(answer => {
      if (answer !== btn && answer.classList.contains('active')) {
        answer.classList.remove('active');
      }
    });

    // удаляем или меняем содержимое блока в зависимости от наличия уже имеющегося ответа
    const existingQuestion = totalTableName.querySelector(`.question-${transliterate(question)}`);
    const existingAnswer = totalTableCol.querySelector(`.question-${transliterate(question)}`);
    if (existingQuestion && existingAnswer) {
      existingQuestion.textContent = questionText + question;
      existingAnswer.textContent = answerText;
    } else {
      const newQuestion = document.createElement('div');
      newQuestion.classList.add("question__text");
      newQuestion.classList.add("price__table-item_name");
      newQuestion.classList.add(`question-${transliterate(question)}`);
      newQuestion.textContent = questionText + question;

      const newAnswer = document.createElement('div');
      newAnswer.classList.add("question__text");
      newAnswer.classList.add("price__table-item_name");
      newAnswer.classList.add(`question-${transliterate(question)}`);
      newAnswer.textContent = answerText;

      totalTableName.appendChild(newQuestion);
      totalTableCol.appendChild(newAnswer);
    }

    // добавляем активный класс к этому варианту ответа
    btn.classList.add('active');
  });
});




function transliterate(text) {
  const translitMap = {
    "Ё": "YO",
    "Й": "I",
    "Ц": "TS",
    "У": "U",
    "К": "K",
    "Е": "E",
    "Н": "N",
    "Г": "G",
    "Ш": "SH",
    "Щ": "SCH",
    "З": "Z",
    "Х": "H",
    "Ъ": "",
    "ё": "yo",
    "й": "i",
    "ц": "ts",
    "у": "u",
    "к": "k",
    "е": "e",
    "н": "n",
    "г": "g",
    "ш": "sh",
    "щ": "sch",
    "з": "z",
    "х": "h",
    "ъ": "",
    "Ф": "F",
    "Ы": "Y",
    "В": "V",
    "А": "A",
    "П": "P",
    "Р": "R",
    "О": "O",
    "Л": "L",
    "Д": "D",
    "Ж": "ZH",
    "Э": "E",
    "ф": "f",
    "ы": "y",
    "в": "v",
    "а": "a",
    "п": "p",
    "р": "r",
    "о": "o",
    "л": "l",
    "д": "d",
    "ж": "zh",
    "э": "e",
    "Я": "YA",
    "Ч": "CH",
    "С": "S",
    "М": "M",
    "И": "I",
    "Т": "T",
    "Ь": "",
    "Б": "B",
    "Ю": "YU",
    "я": "ya",
    "ч": "ch",
    "с": "s",
    "м": "m",
    "и": "i",
    "т": "t",
    "ь": "",
    "б": "b",
    "ю": "yu"
  };
  
  return text.replace(/[ЁЙЦУКЕНГШЩЗХЪёйцукенгшщзхъФЫВАПРОЛДЭфывапролджэЯЧСМИТЬБЮ]/g, function(match) {
    return translitMap[match];
  }).replace(/[\s]/g, "-");
}



let backBtn = document.querySelectorAll(".modal__box-back");

backBtn.forEach((btn, i) => {
  btn.addEventListener("click", () => {
    activeModal.classList.remove("active");
    modalBox[i].classList.add("active");
    activeModal = modalBox[i]; 
  });
});